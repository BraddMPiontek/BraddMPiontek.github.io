---
layout: single
title: 'ASP State and SQL Server: The Mirror Has Three Faces'
date: '2008-07-24T18:00:00.004-05:00'
author: Bradd Piontek
tags:
- sql server
- SQL Mirroring
- ASP State
modified_time: '2008-08-06T17:16:52.720-05:00'
blogger_id: tag:blogger.com,1999:blog-6356090992450002225.post-2350676979520359044
blogger_orig_url: http://piontekdd.blogspot.com/2008/07/asp-state-and-sql-server-mirror-has.html
---

In the spirit of Jonathan Lewis' recent post, <a href="http://how-to-make-a-blog.blogspot.com/2008/07/sometimes-everything-i-write-sucks.html">Sometimes, Everything I Write Sucks!</a>,  comes today's installment of the Prestidigitation of Oracle. Today's <span class="blsp-spelling-corrected" id="SPELLING_ERROR_0">prestidigitation</span> is that I'm not going to write about Oracle (or why I need to blog more), but I'm going to focus on a topic I've been dealing with lately which is implementing the <span class="blsp-spelling-error" id="SPELLING_ERROR_1">ASPState</span> database with <span class="blsp-spelling-error" id="SPELLING_ERROR_2">SQL</span> Mirroring.<br /><br />This is part one in the series and will go over the set up of a custom <a href="http://msdn.microsoft.com/en-us/library/ms972429.aspx">ASP session state</a> database to be used with ASP.NET applications which is connected to a <span class="blsp-spelling-error" id="SPELLING_ERROR_3">SQL</span> Server database that is set up in a <a href="http://www.microsoft.com/technet/prodtechnol/sql/2005/dbmirror.mspx"><span class="blsp-spelling-error" id="SPELLING_ERROR_4">SQL</span> Mirroring</a> set up. This article isn't going to cover the actual <span class="blsp-spelling-error" id="SPELLING_ERROR_5">SQL</span> Mirroring setup. A lot of what I did was learned from an article on <a href="http://www.developer.com/db/article.php/3595766">Storing Session State in a <span class="blsp-spelling-error" id="SPELLING_ERROR_6">SQL</span> Server Database</a>.<br /><br />The ASP session state database has three options you can install with.  A non-persistent database that utilizes <span class="blsp-spelling-error" id="SPELLING_ERROR_7">tempdb</span>, A persistent database that uses  a default database called <span class="blsp-spelling-error" id="SPELLING_ERROR_8">ASPState</span>, and a persistent database that has a name of your choosing. (i.e. Custom database). Hence, the mirror has three faces. Given the premise that we have a <span class="blsp-spelling-error" id="SPELLING_ERROR_9">SQL</span> Server 2005 database set up for <span class="blsp-spelling-error" id="SPELLING_ERROR_10">SQL</span> Mirroring and that we want to keep the session state persistent between restarts as well capable of mirroring. The only choice I see for this is to store the ASP session state information in the applications database. In other words, using the custom option. This keeps the session information encapsulated in the same database as the application itself, and allows the information to be mirrored to another <span class="blsp-spelling-error" id="SPELLING_ERROR_11">SQL</span> Server database.<br /><br /><span style="font-weight: bold;">Installation</span><br />Installing the ASP session state database is fairly straight-forward. The first thing you'll need is the <span style="font-family:Verdana,Arial,Helvetica;"><b><span class="blsp-spelling-error" id="SPELLING_ERROR_12">ASPNET</span>_<span class="blsp-spelling-error" id="SPELLING_ERROR_13">REGSQL</span>.<span class="blsp-spelling-error" id="SPELLING_ERROR_14">EXE</span> </b></span>executable. I found this under the .NET Framework 2.0 directory. I my case, this was the <span style="font-style: italic;">C:\WINDOWS\Microsoft.NET\Framework\v2.0.50727 </span>directory.<br />I prefer Windows authentication, so the installation is fairly straight-forward.<br /><br /><span class="blsp-spelling-error" id="SPELLING_ERROR_15">ASPNET</span>_<span class="blsp-spelling-error" id="SPELLING_ERROR_16">REGSQL</span>.<span class="blsp-spelling-error" id="SPELLING_ERROR_17">EXE</span> -E -<span class="blsp-spelling-error" id="SPELLING_ERROR_18">ssadd</span> -sstype c -d <customdbname> -s <yoursqldatabase><yourappdbhere><br /><br />This will install a couple tables and a bunch of stored procedures into your database. Voila, you now have a custom ASP session state database that should be ready for <span class="blsp-spelling-error" id="SPELLING_ERROR_19">SQL</span> Mirroring.<br /><br />One other step I performed is one of security. Since the ASP session state database is stored procedure based, I need to give the application user the ability to execute stored procedures (i.e. The app will not connect as <span class="blsp-spelling-error" id="SPELLING_ERROR_20">dbo</span> or sysadmin).<br /><br />use <yourappdbhere><br />GO<br />CREATE ROLE db_executor;<br />GO<br />GRANT execute TO db_executor;<br />GO<br /><br />You now have a role that will assume execute privileges on any stored procedure in the database. Assign the role to your application user and everything should work excellent.<br /><br />In the next installment, I hope to cover the testing of persistence in a <span class="blsp-spelling-error" id="SPELLING_ERROR_21">SQL</span> Mirror fail-over scenario. Don't expect it too soon (the prestidigitation continues) and look for more Oracle posts to come soon.</yourappdbhere></yourappdbhere>
